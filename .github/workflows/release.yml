name: "å‘å¸ƒ"

on:
  workflow_dispatch:
  push:
    branches:
      - release

permissions:
  contents: write

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest"
            args: "--target aarch64-apple-darwin"
          - platform: "macos-latest"
            args: "--target x86_64-apple-darwin"
          - platform: "ubuntu-24.04"
            args: ""
            arch: "amd64"
          - platform: "ubuntu-24.04-arm"
            args: ""
            arch: "arm64"
          - platform: "windows-latest"
            args: ""
            arch: "amd64"
          - platform: "windows-11-arm"
            args: ""
            arch: "arm64"

    runs-on: ${{ matrix.platform }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu ä¸“ç”¨)
        if: matrix.platform == 'ubuntu-24.04' || matrix.platform == 'ubuntu-24.04-arm'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf xdg-utils

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Enable Corepack
        run: |
          corepack enable

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: ç¼“å­˜ Rust ç¼–è¯‘äº§ç‰©
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: å®‰è£…å‰ç«¯ä¾èµ– (pnpm)
        run: |
          corepack enable
          corepack prepare pnpm@9.15.9 --activate
          pnpm install --frozen-lockfile

      # ä¿å­˜å½“å‰å·¥ä½œç›®å½•
      - name: ä¿å­˜å·¥ä½œç›®å½•è·¯å¾„
        id: workspace
        run: echo "path=$(pwd)" >> $GITHUB_OUTPUT

      - name: æ„å»ºå¹¶å‘å¸ƒ
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: sea-lantern-v__VERSION__
          releaseName: "Sea Lantern v__VERSION__"
          releaseBody: |
            ## ğŸ‰ å‘å¸ƒ Sea Lantern v__VERSION__

            è¯·åœ¨æ­¤å¤„æ·»åŠ å‘å¸ƒè¯´æ˜ã€‚
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

      # ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„è·¯å¾„æŸ¥æ‰¾ deb æ–‡ä»¶
      - name: ä¸Šä¼  Ubuntu x64 æ„å»ºäº§ç‰© (ç”¨äº AUR æ„å»º)
        if: matrix.platform == 'ubuntu-24.04'
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-build-x64
          path: |
            ${{ steps.workspace.outputs.path }}/target/release/bundle/deb/*_amd64.deb
            ${{ steps.workspace.outputs.path }}/target/release/bundle/appimage/*.AppImage
          if-no-files-found: error

  # Arch Linux æ‰“åŒ…ä»»åŠ¡ - ä¿®å¤æ–‡ä»¶åä¸åŒ¹é…é—®é¢˜
  build-arch-package:
    needs: publish-tauri
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·: $VERSION"

      - name: ä¸‹è½½ Ubuntu x64 æ„å»ºäº§ç‰© (ç”¨äº AUR æ„å»º)
        uses: actions/download-artifact@v4
        with:
          name: ubuntu-build-x64
          path: ./downloads
        continue-on-error: true

      - name: æŸ¥æ‰¾ x64 deb åŒ…
        id: find_deb
        run: |
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la

          if [ -d "./downloads" ]; then
            echo "downloads ç›®å½•å†…å®¹:"
            ls -la ./downloads
            DEB_FILE=$(find ./downloads -name "*_amd64.deb" -type f -print0 | head -z -n 1 | xargs -0 echo)
          fi

          if [ -z "$DEB_FILE" ]; then
            echo "åœ¨æ ¹ç›®å½•æŸ¥æ‰¾ deb æ–‡ä»¶..."
            DEB_FILE=$(find . -name "*_amd64.deb" -type f -print0 | head -z -n 1 | xargs -0 echo)
          fi

          if [ -z "$DEB_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° x64 deb åŒ…æ–‡ä»¶"
            exit 1
          fi

          echo "âœ… æ‰¾åˆ° x64 deb åŒ…: $DEB_FILE"
          cp "$DEB_FILE" ./sealantern.deb
          echo "DEB_FILE=$DEB_FILE" >> $GITHUB_OUTPUT

      - name: è®¾ç½® Arch Linux å®¹å™¨å¹¶å®‰è£…å®Œæ•´ä¾èµ–
        run: |
          docker run --name arch-builder -d \
            -v $PWD:/workspace \
            archlinux:latest \
            sleep infinity

          docker exec arch-builder bash -c "
            useradd -m builder
          "

          docker exec arch-builder bash -c "
            pacman -Syu --noconfirm && \
            pacman -S --noconfirm \
              base-devel \
              binutils \
              file \
              findutils \
              grep \
              sed \
              gawk \
              dpkg \
              cairo \
              gdk-pixbuf2 \
              glib2 \
              gtk3 \
              pango \
              atk \
              libgl \
              webkit2gtk \
              libsoup \
              hicolor-icon-theme \
              adwaita-icon-theme \
              desktop-file-utils \
              shared-mime-info \
              libxss \
              nss \
              nspr \
              libayatana-appindicator \
              libappindicator-gtk3 \
              curl \
              wget \
              openssl \
              ca-certificates \
              gnutls \
              libx11 \
              libxcb \
              libxcomposite \
              libxcursor \
              libxdamage \
              libxext \
              libxfixes \
              libxi \
              libxrandr \
              libxrender \
              libxtst \
              fontconfig \
              freetype2 \
              alsa-lib \
              libpulse \
              sqlite3 \
              zlib \
              bzip2 \
              xz \
              expat \
              libffi \
              pcre \
              pcre2 \
              libgcrypt \
              libgpg-error \
              libdatrie \
              libthai \
              libice \
              libsm \
              util-linux \
              util-linux-libs
          "
          echo "âœ… Arch Linux å®¹å™¨ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ä½¿ç”¨ PKGBUILD æ„å»º Arch åŒ…
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          docker cp sealantern.deb arch-builder:/workspace/
          docker cp PKGBUILD arch-builder:/workspace/
          [ -f "sealantern.install" ] && docker cp sealantern.install arch-builder:/workspace/

          docker exec arch-builder bash -c "
            cd /workspace && \

            # ä¿®æ”¹ PKGBUILDï¼Œä½¿ç”¨æœ¬åœ°æ–‡ä»¶
            sed -i 's|^source=.*|source=(\"sealantern.deb\")|' PKGBUILD && \
            sed -i 's|^sha256sums=.*|sha256sums=(\"SKIP\")|' PKGBUILD && \

            # ä¿®æ”¹ package() å‡½æ•°ä¸­çš„æ–‡ä»¶å
            sed -i 's|Sea\.Lantern_\${pkgver}_amd64\.deb|sealantern.deb|g' PKGBUILD && \

            # æ›´æ–°ç‰ˆæœ¬å·
            sed -i 's/^pkgver=.*/pkgver=$VERSION/' PKGBUILD && \
            sed -i 's/^pkgrel=.*/pkgrel=1/' PKGBUILD && \

            echo '=== ä¿®æ”¹åçš„ PKGBUILD å†…å®¹ ==='
            cat PKGBUILD
            echo '============================='

            chown -R builder:builder /workspace
            su - builder -c 'cd /workspace && makepkg -f --noconfirm'
          "

      - name: ä»å®¹å™¨ä¸­è·å–æ„å»ºäº§ç‰©
        run: |
          docker cp arch-builder:/workspace/*.pkg.tar.* . || true

          if ls *.pkg.tar.* 1> /dev/null 2>&1; then
            echo "âœ… Arch åŒ…ç”ŸæˆæˆåŠŸ"
            ls -la *.pkg.tar.*
          else
            echo "âŒ Arch åŒ…ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: åœæ­¢å¹¶åˆ é™¤å®¹å™¨
        if: always()
        run: |
          docker stop arch-builder || true
          docker rm arch-builder || true

      - name: ä¸Šä¼  Arch åŒ…åˆ° Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: sea-lantern-v${{ steps.get_version.outputs.VERSION }}
          files: |
            *.pkg.tar.*
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼  Arch åŒ…ä½œä¸ºæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: |
            *.pkg.tar.*

name: 要求至少一个 accepted 的 Issue

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

permissions:
  pull-requests: read
  issues: read

jobs:
  check-linked-issue:
    runs-on: ubuntu-latest
    steps:
      - name: 必须关联 accepted Issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;

            // 获取所有关联的 issues
            const query = `
              query($owner:String!, $repo:String!, $number:Int!) {
                repository(owner:$owner, name:$repo) {
                  pullRequest(number:$number) {
                    closingIssuesReferences(first: 50) {
                      nodes {
                        number
                        state
                        labels(first: 50) {
                          nodes { name }
                        }
                        repository {
                          nameWithOwner
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              owner,
              repo,
              number: prNumber
            });

            const prNode = result.repository.pullRequest;
            const repoFull = `${owner}/${repo}`.toLowerCase();

            // 只检查当前仓库的 issue
            const issues = (prNode.closingIssuesReferences.nodes || [])
              .filter(i => `${i.repository.nameWithOwner}`.toLowerCase() === repoFull);

            if (issues.length === 0) {
              core.setFailed("❌ PR 必须关联至少一个 Issue");
              return;
            }

            const valid = issues.some(issue => {
              const hasAccepted = issue.labels.nodes.some(
                l => l.name.trim().toLowerCase() === "accepted"
              );
              return issue.state === "OPEN" && hasAccepted;
            });

            if (!valid) {
              core.setFailed("❌ 关联的 Issue 中，没有一个是 OPEN 且包含 'accepted' 标签");
            } else {
              core.info("✅ 存在符合条件的关联 Issue");
            }
